name: Detect CLI template changes

on:
  workflow_call:
    outputs:
      matrix:
        description: "JSON matrix of {type, template} to run"
        value: ${{ jobs.detect.outputs.matrix }}

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            processing:
              - 'src/picsellia_pipelines_cli/commands/processing/**'
              - 'tests/processing/**'
            training:
              - 'src/picsellia_pipelines_cli/commands/training/**'
              - 'tests/training/**'
            utils_code:
              - 'src/picsellia_pipelines_cli/commands/utils/**'
              - 'src/picsellia_pipelines_cli/main.py'

      - name: Build matrix from changed areas
        id: build-matrix
        shell: bash
        run: |
          echo "== Changes summary =="
          echo "processing    = ${{ steps.changes.outputs.processing }}"
          echo "training      = ${{ steps.changes.outputs.training }}"
          echo "utils_code    = ${{ steps.changes.outputs.utils_code }}"

          get_processing_templates() {
            ls src/picsellia_pipelines_cli/processing/templates/*_template.py 2>/dev/null \
              | xargs -n1 basename \
              | sed 's/_template\.py$//'
          }

          get_training_templates() {
            ls src/picsellia_pipelines_cli/training/templates/*_template.py 2>/dev/null \
              | xargs -n1 basename \
              | sed 's/_template\.py$//'
          }

          PROCESSING_TEMPLATES=($(get_processing_templates))
          TRAINING_TEMPLATES=($(get_training_templates))

          declare -A TO_RUN_PROC=()
          declare -A TO_RUN_TRAIN=()

          mark_all_processing() {
            for t in "${PROCESSING_TEMPLATES[@]}"; do
              TO_RUN_PROC["$t"]=1
            done
          }

          mark_all_training() {
            for t in "${TRAINING_TEMPLATES[@]}"; do
              TO_RUN_TRAIN["$t"]=1
            done
          }

          # utils/main → everything
          if [[ "${{ steps.changes.outputs.utils_code }}" == "true" ]]; then
            echo "utils_code changed → mark ALL processing & training templates"
            mark_all_processing
            mark_all_training
          fi

          # processing (code or tests) → all processing templates
          if [[ "${{ steps.changes.outputs.processing }}" == "true" ]]; then
            echo "processing changed → mark ALL processing templates"
            mark_all_processing
          fi

          # training (code or tests) → all training templates
          if [[ "${{ steps.changes.outputs.training }}" == "true" ]]; then
            echo "training changed → mark ALL training templates"
            mark_all_training
          fi

          entries=()

          for t in "${!TO_RUN_PROC[@]}"; do
            entries+=( "{\"type\":\"processing\",\"template\":\"$t\"}" )
          done

          for t in "${!TO_RUN_TRAIN[@]}"; do
            entries+=( "{\"type\":\"training\",\"template\":\"$t\"}" )
          done

          if [ ${#entries[@]} -eq 0 ]; then
            echo "No templates selected (matrix empty)."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          json='{"include":['
          first=1
          for e in "${entries[@]}"; do
            if [ $first -eq 0 ]; then
              json+=","
            fi
            json+="$e"
            first=0
          done
          json+="]}"

          echo "Computed matrix: $json"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"
