name: Detect CLI template changes

on:
  workflow_call:
    outputs:
      matrix:
        description: "JSON matrix of {type, template} to run"
        value: ${{ jobs.detect.outputs.matrix }}

jobs:
  detect:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            processing:
              - 'src/picsellia_pipelines_cli/commands/processing/**'
              - 'tests/processing/**'
            training:
              - 'src/picsellia_pipelines_cli/commands/training/**'
              - 'tests/training/**'
            utils_code:
              - 'src/picsellia_pipelines_cli/commands/utils/**'
              - 'src/picsellia_pipelines_cli/main.py'

      - name: Build matrix from changed areas
        id: build-matrix
        shell: bash
        run: |
          set -euo pipefail

          echo "== Changes summary =="
          echo "processing    = ${{ steps.changes.outputs.processing }}"
          echo "training      = ${{ steps.changes.outputs.training }}"
          echo "utils_code    = ${{ steps.changes.outputs.utils_code }}"

          get_processing_templates() {
            local dir="src/picsellia_pipelines_cli/commands/processing/templates"
            [[ -d "$dir" ]] || return 0
            find "$dir" -maxdepth 1 -type f -name '*_template.py' -print \
            | while read -r f; do
                basename "$f" | sed 's/_template\.py$//'
              done \
            | sort -u
          }

          get_training_templates() {
            local dir="src/picsellia_pipelines_cli/commands/training/templates"
            [[ -d "$dir" ]] || return 0
            find "$dir" -maxdepth 1 -type f -name '*_template.py' -print \
            | while read -r f; do
                basename "$f" | sed 's/_template\.py$//'
              done \
            | sort -u
          }


          PROCESSING_TEMPLATES=($(get_processing_templates))
          TRAINING_TEMPLATES=($(get_training_templates))

          echo "Found processing templates: ${PROCESSING_TEMPLATES[*]:-<none>}"
          echo "Found training templates:    ${TRAINING_TEMPLATES[*]:-<none>}"

          declare -A TO_RUN_PROC=()
          declare -A TO_RUN_TRAIN=()

          mark_all_processing() { for t in "${PROCESSING_TEMPLATES[@]}"; do TO_RUN_PROC["$t"]=1; done; }
          mark_all_training()  { for t in "${TRAINING_TEMPLATES[@]}";  do TO_RUN_TRAIN["$t"]=1; done; }

          if [[ "${{ steps.changes.outputs.utils_code }}" == "true" ]]; then
            echo "utils_code changed → mark ALL processing & training templates"
            mark_all_processing
            mark_all_training
          fi

          if [[ "${{ steps.changes.outputs.processing }}" == "true" ]]; then
            echo "processing changed → mark ALL processing templates"
            mark_all_processing
          fi

          if [[ "${{ steps.changes.outputs.training }}" == "true" ]]; then
            echo "training changed → mark ALL training templates"
            mark_all_training
          fi

          entries=()
          for t in "${!TO_RUN_PROC[@]}";  do entries+=( "{\"type\":\"processing\",\"template\":\"$t\"}" ); done
          for t in "${!TO_RUN_TRAIN[@]}"; do entries+=( "{\"type\":\"training\",\"template\":\"$t\"}" ); done

          if [ ${#entries[@]} -eq 0 ]; then
            echo "No templates selected (matrix empty)."
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          json='{"include":['
          first=1
          for e in "${entries[@]}"; do
            if [ $first -eq 0 ]; then json+=","; fi
            json+="$e"
            first=0
          done
          json+="]}"

          echo "Computed matrix: $json"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"
