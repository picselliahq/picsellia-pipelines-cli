name: Pipeline templates CI (manual + branch push)

on:
  workflow_dispatch:
    inputs:
      type:
        description: "Template type (processing|training)"
        required: true
        default: "processing"
      template:
        description: "Template name (all | template dir name)"
        required: true
        default: "pre_annotation"
      bump:
        description: "Version bump (patch|minor|major|rc|final)"
        required: true
        default: "final"

  push:
    branches:
      - feat/17-add-ci-to-test-commands-and-templates

jobs:
  run-cli-template-ci:
    runs-on: ubuntu-latest

    # Compute TYPE / TEMPLATE / BUMP once, with defaults for push
    env:
      TYPE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.type || 'processing' }}
      TEMPLATE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.template || 'pre_annotation' }}
      BUMP: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.bump || 'final' }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install uv
        run: pip install uv

      - name: Sync project dependencies
        run: uv sync

      - name: Install cv engine for CLI
        run: uv add "picsellia-cv-engine==0.5.0"

      - name: Run CLI template CI
        env:
          PXL_API_TOKEN: ${{ secrets.PXL_API_TOKEN_STAGING }}
          TYPE: ${{ env.TYPE }}
          TEMPLATE: ${{ env.TEMPLATE }}
          BUMP: ${{ env.BUMP }}
        run: |
          # Use GitHub's built-in RUNNER_TEMP env var
          PICSELLIA_CONFIG_DIR="$RUNNER_TEMP/picsellia_cfg"
          mkdir -p "$PICSELLIA_CONFIG_DIR"

          echo "TYPE=$TYPE"
          echo "TEMPLATE=$TEMPLATE"
          echo "BUMP=$BUMP"
          echo "PICSELLIA_CONFIG_DIR=$PICSELLIA_CONFIG_DIR"

          uv run bash tests/script.sh \
            --type "$TYPE" \
            --template "$TEMPLATE" \
            --organization "test-account" \
            --env "STAGING" \
            --bump "$BUMP" \
            --config-dir "$PICSELLIA_CONFIG_DIR"
